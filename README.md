# ParSpec #

Binned spectrum analysis using a parameterized representation of the spectrum.

### Rationale ###

Many physics analysis require measuring the likelihood of a set of parameters, given an observed binned distribution. They typically rely on the same underlying mechanics, eventhough they are typically expressed differently for different types of analysis (e.g. template fit vs. unfolding).

The likelihood computation can be very expensive, and typically needs to be run a very large number of times such as during minimization.

Given these two points, this package aims to provide a convenient python interface to the common mechanics relied on by nearly all binned analysis, while running the heavy computation in efficient compiled code.

The package also provides a higher level interface to the base mechanics, re-expressing the base functionality in the paradigms of template and unfolding analyses.

#### Note on the compiled code ####

The C++ code generated by this package is compiled using ROOT's ACLIC module. As a design choice, the spectral values are hard-coded before compilation, such that they will be stored on the stack.

Advantages:

* ACLIC takes care of compiling the code on any system.
* PyROOT takes care of interfacing the compiled code to python.
* The data is stored on the stack, allowing for very fast execution.

Drawbacks:

* Each spectrum must be compiled, introducing a slight overhead (typically neglegible so long as the compiled spectrum is indeed complex enough to warrant compilation).
* Compilation generates files in the working directory.
* Each spectrum built in the same session must have a unique name.
* The amount of data is limited by the stack size. A very lage analysis might require 100 sources, each with 100 systematic variants, in 100 bins. This would barely fit in a typical linux 8 MB stack. In the rare case of an exceptionally large amount of data, this limiation can be circumvented.

### Dependencies ###

* `numpy`: scientific computing for python. See ['http://www.numpy.org/'](http://www.numpy.org/).
* `ROOT`: data analysis framework for compiling C++ code which is dynamically linked into python. See [`http://www.root.cern.ch/`](http://www.root.cern.ch/).

The examples depend on the following python modules:

* [`pymcmc.py`](https://github.com/gmcgoldr/pymcmc/raw/master/pymcmc.py): Markov Chain Monte Carlo sampler. See [`https://github.com/gmcgoldr/pymcmc`](https://github.com/gmcgoldr/pymcmc).
* [`npinterval.py`](https://github.com/gmcgoldr/npinterval/raw/master/npinterval.py): numpy computation of confidence intervals and mode. See [`https://github.com/gmcgoldr/npinterval`](https://github.com/gmcgoldr/npinterval).

### Package information ###

Following is a brief explanation of the package functionality as it is organized in its files:

* `parspec.py`
  - `ParSpec` class: computes the expected binned spectrum given a set of parameters, and the likelihood that another spectrum (binned data) arose from this one. These parameters can coherently change the relative contributions of various sources to the spectrum, the overal scale of the spectrum, and statistical fluctuations to each bin.
  - `Source` class: stores information for a source contributing to the spectrum. Used during construction.
  - `SpecBuilder` class: accumulates sources and regularization information from which to build a parameterized spectrum. Writes C++ code for the spectrum, compiles it and builds it into a python `ParSpec` object.

* `parspec.cxx`: C++ code which performs the CPU intensive spectrum computation, and likelihood computation. The code is a template: capital names surrounded by `__` characters are replaced by the `parspec.SpecBuilder.build` method to generate the compilable code for a specific spectrum.

* `templates.py`: interface which exposes `parspec`'s functionality in a manner more convenient for carrying out a template analysis.

* `examples.py`: a series of heavily commented examples showing how to use the higher level `templates` interface.

